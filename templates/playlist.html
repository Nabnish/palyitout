<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Play It Out - Playlist</title>
  <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    body { font-family: Arial, sans-serif; color: #fff; margin: 0; height: 100vh; overflow: hidden; }
    video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -2; }
    body::before { content: ""; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: -1; }
    .nav { list-style: none; display: flex; justify-content: flex-end; gap: 30px; padding: 20px 40px; background: rgba(0,0,0,0.4); }
    .nav li:hover { color: #ff3c78; cursor: pointer; }
    .playlist { position: absolute; top: 120px; left: 50px; max-height: 70vh; overflow-y: auto; padding: 20px;
                background: rgba(0,0,0,0.3); border-left: 3px solid #ff3c78; border-radius: 10px; }
    .playlist-item { margin: 10px 0; padding: 8px; cursor: pointer; border-bottom: 1px dashed rgba(255,255,255,0.3); }
    .playlist-item:hover { color: #0ff; }
    .player { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
              background: rgba(0,0,0,0.7); padding: 20px 30px; border-radius: 25px; display: flex; gap: 20px; }
    .player button { border: 2px solid #ff3c78; background: none; color: #fff; padding: 12px; border-radius: 50%; cursor: pointer; }
    .player button:hover { background: #ff3c78; color: #000; }
  </style>
</head>
<body>
  <video autoplay muted loop>
    <source src="{{ url_for('static', filename='videos/bgvideo.mp4') }}" type="video/mp4">
  </video>

  <ul class="nav">
    <li>Play it out</li><li>Home</li><li>Explore</li><li>Logout</li>
  </ul>

  <div class="playlist">
    <h2>Gemini Playlist</h2>
    {% if songs %}
      {% for song in songs %}
        <div class="playlist-item" data-uri="{{ song.uri }}">{{ song.title }} - {{ song.artist }}</div>
      {% endfor %}
    {% else %}
      <p>No songs yet. Go back to Gemini and create one!</p>
    {% endif %}
  </div>

  <div class="player">
    <button id="prev"><i class="fa-solid fa-backward"></i></button>
    <button id="play"><i class="fa-solid fa-play"></i></button>
    <button id="next"><i class="fa-solid fa-forward"></i></button>
  </div>

  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <script>
    window.onSpotifyWebPlaybackSDKReady = () => {
      const token = {{ session.get('spotify_token', '') | tojson }};
      const trackURIs = {{ songs | map(attribute='uri') | list | tojson }};

      if (!token) { console.error("No Spotify token."); return; }
      if (!trackURIs.length) { console.warn("No tracks in playlist."); return; }

      const player = new Spotify.Player({
        name: 'Play It Out',
        getOAuthToken: cb => cb(token),
        volume: 0.7
      });

      let deviceId = null;
      let currentTrack = 0;

      player.addListener('ready', ({ device_id }) => {
        deviceId = device_id;
        console.log('Ready with Device ID', device_id);
        playTrack(0);
      });

      player.addListener('initialization_error', ({ message }) => console.error(message));
      player.addListener('authentication_error', ({ message }) => console.error(message));
      player.addListener('account_error', ({ message }) => console.error(message));
      player.addListener('playback_error', ({ message }) => console.error(message));

      player.connect();

      function playTrack(index) {
        if (!trackURIs[index]) return;
        fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
          method: 'PUT',
          body: JSON.stringify({ uris: [trackURIs[index]] }),
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }
        });
      }

      document.getElementById('play').addEventListener('click', () => player.togglePlay());
      document.getElementById('next').addEventListener('click', () => {
        currentTrack = (currentTrack + 1) % trackURIs.length;
        playTrack(currentTrack);
      });
      document.getElementById('prev').addEventListener('click', () => {
        currentTrack = (currentTrack - 1 + trackURIs.length) % trackURIs.length;
        playTrack(currentTrack);
      });

      document.querySelectorAll('.playlist-item').forEach((item, index) => {
        item.addEventListener('click', () => {
          currentTrack = index;
          playTrack(currentTrack);
        });
      });
    };
  </script>
</body>
</html>
